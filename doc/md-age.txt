*md-age.txt*  Transparent age encryption for markdown files

Author:  Danny O'Brien <danny@spesh.com>
License: AGPL-3.0-or-later

INTRODUCTION                                    *md-age*

md-age-vim provides transparent encryption and decryption of markdown files
using age (https://age-encryption.org/). Files are automatically decrypted
when opened and encrypted when saved, based on YAML frontmatter configuration.

CONFIGURATION                                   *md-age-config*

                                                *g:md_age_identity*
g:md_age_identity~
    Required. Command-line arguments for age identity.
    Examples: >
        let g:md_age_identity = '-i ~/.age/identity.txt'
        let g:md_age_identity = '-j'  " for age plugins
<
                                                *g:md_age_command*
g:md_age_command~
    Optional. The age command to use. Default: 'age'
    Example: >
        let g:md_age_command = 'rage'
<
                                                *g:md_age_default_recipients*
g:md_age_default_recipients~
    Optional. Default recipients for |:MdAgeInit| template.
    Can be a string or list. Example: >
        let g:md_age_default_recipients = 'age1ql3z7...'
        let g:md_age_default_recipients = ['age1...', '~/.age/backup.pub']
<
FRONTMATTER FORMAT                              *md-age-frontmatter*

Enable encryption by adding these fields to YAML frontmatter: >

    ---
    title: My Document
    age-encrypt: yes
    age-recipients:
      - age1ql3z7hjy54pw...
      - ~/.age/recipients.txt
      - ssh-ed25519 AAAA...
    ---
<
Recipients can be:
- age public keys (starting with 'age1')
- SSH public keys (starting with 'ssh-')
- Paths to recipient files (anything else, uses -R flag)

COMMANDS                                        *md-age-commands*

                                                *:MdAgeInit*
:MdAgeInit          Insert frontmatter template at top of buffer.

                                                *:MdAgeStatus*
:MdAgeStatus        Show current encryption status and recipients.

GIT INTEGRATION                                 *md-age-git*

The `md-age` command-line tool (in bin/) supports git smudge/clean filters
for transparent encryption in repositories.

                                                *md-age-git-setup*
Setup: >
    md-age git init                    " configure filters and .gitattributes
    md-age git config add -i ~/.age/key.txt
<
                                                *md-age-git-commands*
Git subcommands:~
    md-age git init              Set up filters and .gitattributes
    md-age git config add -i     Add identity for decryption
    md-age git config list       Show configured identities
    md-age git config remove -i  Remove identity
    md-age git add-dir <path>    Set up a directory for encryption
    md-age git rekey [files...]  Re-encrypt files with current recipients
    md-age git clean             Encrypt filter for markdown (called by git)
    md-age git smudge            Decrypt filter for markdown (called by git)
    md-age git dir-clean         Encrypt filter for directories (called by git)
    md-age git dir-smudge        Decrypt filter for directories (called by git)

Files with `age-encrypt: yes` in frontmatter are encrypted on commit and
decrypted on checkout. Other markdown files pass through unchanged.

                                                *md-age-git-identity*
Dynamic identities:~

Use cmd: prefix to fetch identity from a command: >
    md-age git config add -i "cmd:pass age/my-key"
<
This runs the command and uses its output as the identity, useful for
password managers like pass or 1password-cli.

DIRECTORY ENCRYPTION                            *md-age-dir*

Encrypt entire directories of arbitrary files. Each file is individually
encrypted in a frontmatter envelope. The working tree has raw plaintext;
git stores encrypted blobs.

                                                *md-age-dir-setup*
Setup: >
    md-age git init
    md-age git config add -i ~/.age/key.txt
    echo 'age1...' > .age-recipients
    md-age git add-dir secrets/
<
                                                *md-age-dir-age-encrypt*
.age-encrypt~
    Empty marker file. Its presence in a directory triggers encryption
    for all files in that directory. Created by `md-age git add-dir`.

                                                *md-age-dir-age-recipients*
.age-recipients~
    Lists recipients, one per line. Comments start with `#`.
    The clean filter searches from the file's directory up to the git
    root, using the nearest `.age-recipients` found. >

        # .age-recipients
        age1example7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        ssh-ed25519 AAAA...
        git:path/to/recipients-file
<
    Place at the repo root for all directories, or in a subdirectory
    to override recipients for that directory.

                                                *md-age-dir-add-dir*
md-age git add-dir <path>~
    Set up a directory for encryption. Creates `.age-encrypt` marker
    and appends filter rules to `.gitattributes`. Idempotent.

                                                *md-age-dir-rekey*
md-age git rekey [path...]~
    Re-encrypt files with current recipients from `.age-recipients`.
    Use after adding or removing recipients.

KNOWN LIMITATIONS                               *md-age-limitations*

Passphrase-protected identities are not currently supported when using
`system()` calls, as there is no TTY available for the passphrase prompt.

Workarounds:
- Use an unencrypted age identity file
- Use age plugins that handle auth differently (e.g., age-plugin-yubikey)
- Use the upcoming `age-plugin-batchpass` (expected in a future age release)
  which reads passphrases from environment variables or file descriptors

Native age keys are recommended for scripted/non-interactive use. You can
encrypt directly to the private key: >
    age-keygen -o key.txt
    let g:md_age_identity = '-i ~/key.txt'
<
Or use an environment variable: >
    export AGE_SECRET=$(age-keygen)
    let g:md_age_identity = '-i <(echo "$AGE_SECRET")'
<

ERROR HANDLING                                  *md-age-errors*

If decryption fails (wrong key, corrupted file):
- Buffer is set to read-only
- Encrypted content remains visible
- Error message is displayed

If encryption fails:
- Save is aborted
- Error message is displayed

 vim:tw=78:ts=8:ft=help:norl:
